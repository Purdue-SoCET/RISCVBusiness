// A dual core version of mergesort

#include "utility.h"
#include <stdlib.h>
#include <string.h>

// In order to properly run with N >= 512, you need to bump the size of the stack for each hart in
// start.S
#define N 16
#include "merge.h"

#define NUM_HART 4

// #define WARMUP

uint32_t arr[2048] = {
    1157, 4050, 3787, 2591, 2747, 1917, 4068, 1552, 967,  2724, 2987, 2097, 2097, 4603, 2762, 3992,
    4829, 4542, 2097, 5074, 811,  2596, 881,  5462, 5624, 4872, 1004, 3047, 5512, 2171, 5917, 3723,
    1921, 90,   12,   869,  4173, 5360, 3171, 72,   5537, 2588, 2334, 519,  5444, 1256, 4287, 3005,
    4797, 4093, 2500, 3311, 980,  2078, 1232, 1036, 4571, 2101, 2761, 4593, 4104, 4243, 2189, 3695,
    5290, 5927, 547,  5773, 5869, 3017, 4540, 5576, 3108, 2155, 2867, 5516, 3827, 4523, 2509, 3261,
    3055, 1376, 2128, 4442, 3069, 1494, 2923, 783,  5922, 702,  3501, 1196, 2881, 4338, 1086, 776,
    2897, 2634, 2283, 4,    3269, 5245, 5563, 4155, 2816, 1399, 851,  668,  4901, 2679, 3994, 2646,
    2309, 4358, 5509, 5229, 402,  1966, 380,  1805, 981,  1871, 727,  1976, 847,  3215, 4870, 4596,
    5554, 3410, 5830, 5112, 2659, 4930, 4164, 3119, 4130, 608,  1360, 747,  5343, 1138, 4454, 3798,
    2800, 5375, 4097, 5277, 2973, 5005, 108,  2224, 849,  1790, 2012, 221,  5798, 663,  1534, 2045,
    2872, 545,  2348, 1598, 2377, 5834, 3311, 2761, 1133, 2233, 3684, 1116, 186,  2448, 562,  5854,
    1531, 1615, 3196, 5419, 269,  1351, 2585, 3639, 2619, 4007, 1016, 3287, 2970, 2321, 3595, 210,
    2935, 4104, 2774, 396,  1655, 4186, 308,  3083, 4397, 5031, 3111, 4395, 3008, 922,  1315, 4180,
    2681, 1774, 5919, 135,  5992, 69,   2770, 8,    4790, 2990, 438,  216,  5278, 3175, 2332, 43,
    1150, 2397, 5725, 1297, 443,  3281, 2500, 992,  1257, 907,  2346, 1996, 5598, 1449, 2131, 5368,
    809,  5977, 2750, 2299, 671,  1173, 3193, 4740, 4768, 4928, 1903, 501,  1435, 5544, 1099, 3256,
    2815, 5129, 1269, 5392, 414,  4416, 379,  3899, 1925, 5443, 2152, 3725, 182,  1575, 1447, 5008,
    4266, 290,  2519, 37,   2426, 4457, 4557, 1105, 0,    56,   353,  2627, 966,  3705, 871,  10,
    2119, 2077, 4828, 675,  5123, 4241, 5159, 5609, 835,  2714, 3711, 950,  3251, 3188, 375,  2319,
    1224, 3615, 5049, 192,  2975, 5452, 1832, 1870, 3758, 127,  4335, 4105, 4158, 3417, 3535, 3273,
    807,  99,   728,  3376, 546,  1750, 1659, 3668, 4060, 1466, 316,  3514, 556,  2727, 4820, 4922,
    5760, 3907, 4144, 1106, 5514, 1770, 3198, 1298, 3812, 5366, 4951, 1356, 5842, 4368, 5537, 48,
    5601, 4655, 3647, 3541, 5083, 4870, 4580, 158,  3592, 4905, 4440, 4782, 5376, 2270, 5526, 4161,
    3034, 4758, 2337, 4600, 3107, 1728, 3215, 4113, 2910, 3469, 704,  3733, 584,  5054, 3527, 2585,
    1253, 724,  2702, 1995, 4827, 2535, 1182, 4368, 4245, 5346, 1554, 3484, 3915, 3676, 2845, 1592,
    5564, 3870, 2064, 23,   2568, 4684, 1337, 2230, 841,  3615, 5800, 5829, 2855, 3573, 4188, 1858,
    5523, 1852, 3680, 3345, 2164, 4440, 900,  4942, 3822, 1410, 5328, 5473, 1944, 2626, 1664, 4180,
    5125, 4883, 1921, 4034, 2656, 2108, 753,  5698, 2764, 5607, 4421, 4284, 1836, 4414, 484,  2433,
    3198, 3171, 76,   5476, 2038, 1959, 1450, 2907, 4645, 5645, 81,   2000, 2133, 1,    5461, 2553,
    1804, 906,  3573, 550,  632,  2806, 2371, 3282, 2972, 2500, 4931, 2018, 496,  64,   1855, 5003,
    4532, 5574, 4020, 851,  2274, 1683, 2494, 5181, 1831, 5518, 2363, 1290, 1865, 2340, 269,  5793,
    5796, 3665, 3024, 2957, 2724, 4685, 4168, 280,  2838, 5432, 5988, 4219, 3609, 135,  4392, 4057,
    2599, 2042, 1995, 2915, 5851, 3985, 1510, 3093, 240,  1446, 348,  5476, 1959, 1543, 2385, 1359,
    3905, 2380, 5783, 1910, 1093, 5994, 977,  1491, 717,  534,  3157, 4734, 5754, 3177, 2445, 5254,
    1470, 3283, 3475, 182,  3824, 439,  2692, 3972, 1349, 1897, 3340, 5179, 5324, 3238, 2207, 841,
    737,  4613, 4872, 571,  897,  4828, 1323, 4648, 3896, 2706, 107,  4904, 3778, 2755, 808,  3579,
    4231, 2037, 4666, 5820, 3279, 1468, 1728, 5309, 4190, 21,   903,  3005, 5060, 2247, 1026, 405,
    4448, 137,  5949, 1597, 3665, 346,  5139, 3238, 5972, 5723, 4160, 5771, 999,  5035, 1495, 2742,
    2125, 4266, 792,  2895, 1513, 1396, 109,  4602, 3874, 5854, 4451, 725,  2603, 765,  10,   489,
    37,   996,  3321, 95,   3094, 4787, 2864, 2095, 4313, 293,  5164, 2846, 130,  4677, 360,  4362,
    958,  3944, 4296, 66,   620,  3015, 3756, 3585, 2607, 4584, 27,   3374, 641,  4684, 3439, 93,
    4241, 1148, 2251, 206,  136,  2833, 3916, 819,  5782, 4322, 5350, 2757, 2396, 4754, 5241, 176,
    1895, 1701, 3490, 5926, 3706, 5797, 5454, 311,  2355, 4323, 4813, 2184, 3489, 5949, 299,  5073,
    591,  3811, 1225, 3293, 4571, 4035, 4149, 4725, 3103, 3025, 3251, 1507, 2989, 973,  2889, 2119,
    138,  1256, 187,  5553, 1845, 1507, 4076, 3999, 1409, 5079, 2392, 3802, 1134, 571,  1944, 5258,
    2823, 1573, 4346, 4567, 4303, 872,  1631, 2135, 1925, 3512, 2596, 4911, 3233, 4143, 4909, 2758,
    5732, 725,  2251, 5774, 4084, 950,  4405, 5078, 3976, 4691, 5239, 2252, 5770, 4994, 4531, 5909,
    5540, 5878, 846,  4877, 3619, 1920, 101,  5085, 4410, 3562, 5628, 3929, 4423, 460,  3958, 4524,
    3653, 3459, 3736, 4144, 3383, 2386, 2756, 5371, 4703, 1657, 3299, 551,  841,  3971, 292,  2678,
    1083, 3640, 3322, 659,  2507, 2796, 2430, 4799, 5711, 1137, 946,  227,  2954, 3760, 3107, 2263,
    632,  2519, 5853, 824,  3961, 3512, 5006, 3582, 3061, 2845, 5814, 2125, 2649, 2844, 2902, 2516,
    201,  3432, 846,  3863, 1299, 4539, 3708, 3072, 1375, 755,  4531, 1708, 5755, 5391, 4511, 318,
    4801, 1239, 3995, 3210, 5434, 3291, 3866, 3227, 4012, 4474, 3016, 890,  370,  534,  3884, 3894,
    2324, 4991, 675,  845,  1608, 228,  1530, 4932, 3530, 2670, 756,  1693, 747,  4967, 778,  2632,
    5659, 3070, 3353, 5934, 4582, 4459, 1722, 2670, 1442, 4155, 622,  5211, 4373, 1801, 736,  1518,
    1718, 2363, 2346, 5084, 4516, 1665, 5669, 3051, 5773, 3061, 2935, 3187, 4782, 5503, 5240, 2495,
    129,  5452, 2558, 5626, 4541, 2136, 3915, 4465, 5969, 5936, 2163, 4565, 412,  4192, 800,  125,
    3876, 208,  691,  106,  4740, 5583, 847,  10,   4923, 2285, 4836, 1643, 192,  2001, 3567, 2213,
    2021, 33,   5168, 2252, 2861, 3414, 3398, 3821, 1906, 2035, 2433, 1723, 3037, 1019, 1947, 4805,
    4978, 4992, 42,   5650, 3978, 691,  5669, 5483, 5281, 3853, 3759, 1201, 4653, 3743, 2459, 836,
    1143, 1792, 4135, 2824, 3383, 561,  4135, 996,  3287, 132,  4814, 4198, 1123, 1502, 1215, 5399,
    1457, 4469, 247,  3792, 1758, 1228, 2635, 1214, 700,  1450, 4130, 4901, 4844, 3076, 827,  3897,
    920,  3795, 3731, 4775, 280,  5124, 2236, 2783, 3271, 1866, 207,  3863, 175,  1339, 1220, 2101,
    4511, 845,  5191, 1083, 3436, 4268, 112,  3233, 785,  352,  3600, 1552, 174,  3059, 5956, 4168,
    5414, 3661, 651,  5095, 3481, 1198, 1238, 277,  4448, 4568, 2903, 68,   1664, 2262, 5457, 3291,
    3401, 487,  1785, 1715, 2368, 1069, 53,   3970, 3199, 5520, 3496, 1900, 5013, 5538, 4416, 2678,
    4474, 2051, 4210, 2440, 1896, 1095, 2358, 2518, 153,  1468, 520,  2375, 4633, 3102, 244,  3828,
    2777, 545,  4185, 2953, 106,  2018, 1728, 2682, 3142, 5267, 4704, 5142, 4487, 749,  2896, 5976,
    2513, 4295, 3154, 5277, 1038, 5881, 4980, 4420, 2816, 123,  2639, 4425, 2861, 5675, 1017, 1205,
    5680, 705,  5739, 4796, 3318, 4702, 1020, 251,  4727, 594,  2415, 5555, 5959, 356,  1169, 374,
    1351, 3729, 2682, 84,   2967, 785,  3462, 3583, 1354, 4591, 5907, 2648, 3135, 5069, 5,    229,
    1678, 2744, 1626, 2118, 1483, 4000, 2562, 5789, 1766, 1584, 1604, 2894, 4708, 1106, 2496, 5428,
    5756, 1375, 5957, 1673, 2862, 5204, 5057, 3354, 3201, 1460, 822,  1849, 4251, 2045, 1287, 3697,
    2825, 3781, 2940, 1021, 4672, 5213, 2714, 4754, 5087, 5799, 2970, 4976, 3843, 2941, 5593, 323,
    3204, 1576, 98,   1399, 71,   3272, 1984, 4691, 3309, 990,  2395, 5155, 5125, 701,  5767, 2780,
    4826, 4156, 4995, 762,  4920, 5547, 5323, 4663, 5105, 1421, 4473, 4659, 1814, 2833, 3967, 3231,
    1780, 3362, 3102, 4598, 2813, 1806, 2183, 2802, 5625, 5660, 758,  3482, 3249, 4828, 123,  452,
    2046, 4929, 4112, 4773, 3575, 3920, 5172, 3167, 921,  4489, 5360, 3847, 4504, 1770, 2288, 398,
    764,  110,  5306, 3666, 1549, 4931, 3980, 5564, 4145, 1813, 838,  1826, 4847, 2998, 5926, 4418,
    2264, 1912, 5042, 5515, 148,  850,  4576, 5408, 2299, 88,   106,  3104, 5604, 4389, 1286, 3291,
    3896, 1694, 510,  838,  1509, 3081, 3473, 954,  5863, 1740, 2806, 2150, 3716, 3748, 656,  306,
    4982, 3580, 4163, 1912, 5009, 3369, 5883, 2421, 1352, 3679, 4200, 1233, 943,  2204, 1015, 1543,
    4482, 2113, 5320, 4284, 5929, 2317, 5771, 5878, 1574, 2998, 2542, 2308, 2769, 1940, 3557, 3577,
    3822, 2821, 5093, 894,  2352, 5801, 3737, 2557, 2648, 1524, 3474, 4654, 3523, 2498, 173,  4903,
    4267, 3589, 1708, 1990, 5600, 3174, 4365, 1023, 434,  5792, 982,  3786, 1885, 3158, 2481, 4119,
    4663, 1361, 865,  4885, 5064, 99,   666,  2700, 2134, 657,  4726, 1780, 4544, 4077, 1401, 1135,
    3655, 4385, 5978, 2613, 3081, 1552, 2962, 807,  1112, 3334, 789,  1833, 4537, 5449, 1731, 540,
    4512, 2476, 3296, 4130, 565,  3162, 4814, 2864, 351,  5072, 2498, 1993, 2875, 3189, 5171, 2282,
    3626, 3421, 2878, 5301, 77,   2969, 1765, 1796, 1093, 5806, 1706, 2357, 1397, 5847, 3797, 4842,
    2615, 4142, 5112, 3591, 3233, 381,  1537, 5245, 457,  1902, 4254, 3112, 466,  1621, 5849, 5420,
    1453, 5571, 5443, 3386, 138,  2306, 2695, 2273, 1525, 5076, 1880, 396,  4886, 2401, 5693, 5090,
    3475, 3873, 1511, 4087, 4753, 4227, 3996, 4659, 83,   1321, 602,  5580, 4825, 3744, 3503, 5618,
    2797, 5093, 3906, 499,  3308, 5507, 1913, 3410, 3139, 5611, 2931, 129,  2551, 3922, 3804, 1010,
    652,  5339, 3933, 248,  4812, 4812, 5956, 461,  5165, 3761, 5816, 1042, 5143, 1317, 2564, 3998,
    2287, 4376, 2446, 2658, 2377, 4893, 5077, 5945, 1451, 3194, 1948, 3242, 2352, 5349, 4510, 5945,
    234,  4933, 2446, 879,  2971, 281,  543,  1955, 5776, 636,  1097, 2378, 2939, 5544, 1839, 5689,
    1254, 2927, 3368, 3668, 3688, 3296, 3164, 5851, 4030, 4947, 2817, 2265, 4306, 956,  647,  2820,
    1299, 2788, 3886, 2143, 4438, 36,   5833, 2268, 2715, 1501, 1256, 275,  5406, 764,  2222, 2060,
    5803, 4011, 5274, 5202, 2225, 3080, 1217, 3497, 5091, 578,  1095, 1890, 2480, 3139, 1763, 2521,
    4173, 5156, 1057, 1585, 4228, 5310, 5588, 2507, 3139, 93,   267,  696,  2164, 4219, 2783, 4113,
    3061, 1927, 4634, 417,  3578, 5400, 5060, 3163, 4624, 3772, 3975, 4034, 5320, 120,  3587, 5330,
    3797, 1911, 2599, 5065, 142,  5124, 5608, 3797, 1871, 4483, 3002, 1580, 2371, 1962, 4926, 2559,
    1974, 932,  317,  3559, 2344, 5440, 5176, 4667, 1161, 178,  5822, 4873, 896,  5866, 2373, 2268,
    5230, 2385, 2096, 1062, 2091, 3640, 1698, 2914, 4402, 2008, 3509, 612,  423,  5713, 754,  843,
    1176, 1813, 1814, 2983, 5705, 4617, 144,  2795, 5082, 2453, 888,  1943, 773,  2067, 5591, 710,
    2003, 78,   3290, 4071, 3543, 227,  2289, 5857, 4861, 1248, 4271, 1047, 1116, 5830, 3735, 713,
    2157, 5547, 5028, 693,  5218, 2991, 5899, 3396, 4004, 3650, 4120, 4667, 3346, 4401, 3081, 1834,
    4875, 2062, 5524, 3038, 1442, 4332, 55,   642,  920,  3085, 3194, 3945, 1144, 4755, 3525, 5211,
    681,  5187, 5935, 29,   1312, 1586, 3463, 4430, 5309, 3446, 864,  5826, 5127, 4199, 1028, 1395,
    4009, 2306, 2128, 392,  4302, 5439, 2714, 4240, 5234, 1688, 4303, 4225, 2217, 2481, 3445, 4350,
    2490, 4057, 1160, 3953, 2805, 2166, 5980, 5647, 879,  5232, 603,  3735, 5434, 3254, 4494, 3647,
    609,  3004, 2996, 4657, 3445, 3678, 519,  3942, 4693, 5557, 5673, 3193, 3873, 101,  4149, 4576,
    5880, 1322, 2473, 3939, 4262, 2599, 4220, 5524, 2183, 4665, 932,  1996, 677,  5417, 5250, 1950,
    765,  4664, 3582, 2118, 3486, 5861, 4447, 5135, 1735, 1730, 3448, 4143, 3531, 5621, 5703, 5525,
    4478, 2332, 2031, 459,  4487, 288,  354,  110,  363,  3439, 2368, 5524, 3234, 1201, 1210, 5057,
    5113, 601,  5912, 3447, 3237, 4476, 5477, 1648, 2798, 3393, 2000, 2187, 128,  2787, 4703, 4334,
    4643, 3116, 2909, 1554, 3348, 3193, 292,  5683, 5809, 4962, 2917, 624,  2482, 3185, 3852, 4206,
    3635, 3016, 534,  4076, 3641, 5491, 4256, 4834, 2135, 2846, 4554, 3808, 322,  517,  2304, 1621,
    5321, 4720, 3845, 1638, 5062, 3864, 2959, 3822, 5292, 2845, 2350, 3412, 1235, 1714, 2459, 656,
    2126, 3956, 906,  509,  1622, 5078, 3747, 3010, 1595, 2768, 3413, 2099, 2644, 905,  248,  3889,
    3974, 2525, 534,  4794, 3351, 5643, 3530, 3685, 1921, 1063, 2608, 2997, 211,  5120, 175,  4481,
    2174, 4701, 2235, 973,  2023, 4787, 1760, 2543, 1017, 114,  3036, 4164, 1274, 586,  4938, 1379,
    5208, 359,  4276, 2659, 345,  815,  4008, 3881, 984,  3506, 3624, 3071, 460,  2251, 4924, 2377,
    929,  2025, 3641, 803,  3346, 3919, 2467, 3224, 5266, 4863, 4296, 4535, 3474, 1461, 919,  1531,
    2659, 4361, 1445, 4832, 1972, 49,   175,  1912, 1568, 749,  4867, 4981, 1189, 5957, 5245, 3204,
    427,  3240, 4345, 3871, 1619, 1396, 3460, 4584, 5071, 842,  4906, 3213, 1556, 4189, 31,   500,
    2806, 4116, 5186, 3432, 3730, 3366, 5506, 3578, 3454, 3295, 3650, 3067, 4525, 3503, 2566, 3688,
    1899, 4490, 1971, 1982, 720,  1403, 2296, 2575, 3008, 3429, 2822, 4542, 999,  1397, 3389, 276};

__attribute__((section(".noinit"))) uint32_t temp_arr_1[2048];
__attribute__((section(".noinit"))) uint32_t temp_arr_2[2048];
__attribute__((section(".noinit"))) uint32_t temp_arr_3[2048];

void check_sorted() {
    if(NUM_HART == 1) {
        for (int i = 0; i < N - 1; i++) {
            if(arr[i] > arr[i + 1]) {
                print("not sorted!\n");
                return;
            }
        }
    }
    else if (NUM_HART == 2) {
        for (int i = 0; i < N - 1; i++) {
            if(temp_arr_1[i] > temp_arr_1[i + 1]) {
                print("not sorted!\n");
                return;
            }
        }
    }
    else if (NUM_HART == 4) {
        for (int i = 0; i < N - 1; i++) {
            if(temp_arr_2[i] > temp_arr_2[i + 1]) {
                print("not sorted!\n");
                return;
            }
        }
    }
    else if (NUM_HART == 8) {
        for (int i = 0; i < N - 1; i++) {
            if(temp_arr_3[i] > temp_arr_3[i + 1]) {
                print("not sorted!\n");
                return;
            }
            print("%x\n", temp_arr_3[i]);
        }
    }
    print("sorted!\n");
}

void warmup() {
    #ifdef WARMUP
    volatile uint32_t temp = 0;
    for(int i = 0; i < N; i ++) {
        temp = arr[i];
    }
    #endif
}

void hart0_main() {
    warmup();
    int beginning_cycle = get_cycles();

    int mhartid = get_mhartid();
    int start_index = N / NUM_HART * mhartid;
    int block_size = N / NUM_HART;
    mergeSort(&arr[start_index], block_size);

    hart_done = 1;

    // 2 cores
    if(NUM_HART > 1) {
        wait_for_hart1_done();
        merge(arr, temp_arr_1, 0, block_size - 1, block_size * 2 - 1);
    }
    // 4 cores
    if(NUM_HART > 2) {
        wait_for_hart2_done();
        merge(temp_arr_1, temp_arr_2, 0, block_size * 2 - 1, block_size * 4 - 1);
    }
    // 8 cores
    if(NUM_HART > 4) {
        wait_for_hart4_done();
        merge(temp_arr_2, temp_arr_3, 0, block_size * 4 - 1, block_size * 8 - 1);
    }

    int ending_cycle = get_cycles();
    print("Took %x cycles\n", ending_cycle - beginning_cycle);
    check_sorted();
    flag = 1;
}

void hart1_main() {
    warmup();
    int mhartid = get_mhartid();
    int start_index = N / NUM_HART * mhartid;
    int block_size = N / NUM_HART;
    mergeSort(&arr[start_index], block_size);
    hart1_done = 1;
}

void hart2_main() {
    warmup();
    int mhartid = get_mhartid();
    int start_index = N / NUM_HART * mhartid;
    int block_size = N / NUM_HART;
    mergeSort(&arr[start_index], block_size);

    if(NUM_HART > 3) {
        wait_for_hart3_done();
        merge(arr, temp_arr_1, start_index, block_size - 1, block_size * 2 - 1);
    }

    hart2_done = 1;
}

void hart3_main() {
    warmup();
    int mhartid = get_mhartid();
    int start_index = N / NUM_HART * mhartid;
    int block_size = N / NUM_HART;
    mergeSort(&arr[start_index], block_size);
    hart3_done = 1;
}
void hart4_main() {
    warmup();
    int mhartid = get_mhartid();
    int start_index = N / NUM_HART * mhartid;
    int block_size = N / NUM_HART;
    mergeSort(&arr[start_index], block_size);

    hart4_done = 1;

    // 2 cores
    if(NUM_HART > 1) {
        wait_for_hart5_done();
        merge(arr, temp_arr_1, start_index, block_size - 1, block_size * 2 - 1);
    }
    // 4 cores
    if(NUM_HART > 2) {
        wait_for_hart6_done();
        merge(temp_arr_1, temp_arr_2, start_index, block_size * 2 - 1, block_size * 4 - 1);
    }

    hart4_done = 1;
}
void hart5_main() {
    warmup();
    int mhartid = get_mhartid();
    int start_index = N / NUM_HART * mhartid;
    int block_size = N / NUM_HART;
    mergeSort(&arr[start_index], block_size);

    hart5_done = 1;
}
void hart6_main() {
    warmup();
    int mhartid = get_mhartid();
    int start_index = N / NUM_HART * mhartid;
    int block_size = N / NUM_HART;
    mergeSort(&arr[start_index], block_size);

    if(NUM_HART > 6) {
        wait_for_hart7_done();
        merge(arr, temp_arr_1, start_index, block_size - 1, block_size * 2 - 1);
    }

    hart6_done = 1;
}
void hart7_main() {
    warmup();
    int mhartid = get_mhartid();
    int start_index = N / NUM_HART * mhartid;
    int block_size = N / NUM_HART;
    mergeSort(&arr[start_index], block_size);

    hart7_done = 1;
}
